// Firebase SDK
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import { getFirestore, collection, addDoc, doc, updateDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

// Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyCOqqnnBNSACBh9WzjqiEPSinrBJ2ixeuw",
  authDomain: "ieee-34131.firebaseapp.com",
  projectId: "ieee-34131",
  storageBucket: "ieee-34131.firebasestorage.app",
  messagingSenderId: "133827734645",
  appId: "1:133827734645:web:5ca85322918d7ed28f5c3c",
  measurementId: "G-VCJDRWNC64"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// Quiz Data - Mixed Funny and Branch Questions
const quizData = {
    questions: [
        // Funny Questions
        {
            question: "ุฃูุชุฑ ุญุงุฌุฉ ุงุชุนููุชูุง ูู ุงูุณุงููู ุฏู: ๐ญ",
            answers: ["ุฅู ุงูููู ุฑูุงููุฉ", "ูุนูู ุฅูู teamwork ุจุฌุฏ", "ุฅู ุงููุงู ูุงู ุบุฏุงุฑ", "ุฅู ุงูููุชูุฌุงุช ูุง ุจุชุฎูุตุด"],
            correct: 3
        },
        {
            question: "ููุง ุงูููุฏ ูููู 'ุนูุฏู announcement ุจุณูุท'ุ ุฅุญูุง:",
            answers: ["ุจููุฑุจ ูู ุงูุฌุฑูุจ", "ุจูุนุฑู ุฅู ูู ุดุบู ุฌุงู ูู ุงูุทุฑูู", "ุจูุนูู ูููุช", "ุจูููู 'ูุง ุฑุจ ุฎูุฑ'"],
            correct: 2
        },
        {
            question: "ุงููุงูุณ ููุง ูููู 'ูุชููููุด ูุง ุฌูุงุนุฉ'ุ ูุนูุงูุง ุบุงูุจูุง: ๐",
            answers: ["ูู ุญุงุฌุฉ ูุชููุน", "ูุนูุงู ูุชููููุดุ ููู ุชุญุช ุงูุณูุทุฑุฉ", "ูู ููุณู ูููุงู", "ุงุญูุง ูุฏู ูุฏู ููููู"],
            correct: 0
        },
        {
            question: "ุฃูุชุฑ ุฌููุฉ ุจูุณูุนูุง ูู ุงูุณุงููู: ๐ญ",
            answers: ["'ูู ุชุนุฏูู ุจุณูุท ูู ุงูุชุงุณู'", "'ุญุฏ ูุงุถู ุฎูุณ ุฏูุงููุ'", "'ููู ูุนูุฏูุด ูุชุ'", "'ุงูุง ููุช ูุงูู ุขุณูุฉ ๐'"],
            correct: 0
        },
        {
            question: "ุฃูู ูุง ุจูุณูุน ูููุฉ 'ุณูุดู'ุ ุฅุญูุง:",
            answers: ["ุจูููู 'ุชุงูููููุ' ๐", "ุจููุชุญ ุงููุงุจุชูุจ ุจุญูุงุณ", "ุจูููุจ ูู ุงูุฑูููุฒ", "ุจูุญุถุฑ ุฌุจุฑ ุฎูุงุทุฑ"],
            correct: 3
        },
        {
            question: "ุฃูุชุฑ ุญุงุฌุฉ ุจุชุฎูู ุงูุณูุดู ุญููุฉ:",
            answers: ["ุงูุจุฑูู ๐", "ุงูุชูุงุนู ูุงูุถุญู", "ุงูุจุงูุฑุจูููุช ุงููุชุญุฑู", "ููุง ุงููุช ููุตู"],
            correct: 0
        },
        {
            question: "ููุง ุงูุฏูุฏูุงูู ูุชุฃุฌูุ ุฅุญูุง:",
            answers: ["ุจูุฑูุต ูู ุงููุฑุญุฉ", "ุจูุจุฏุฃ ูุดุชุบู ูุนูุงู", "ุจููุงู ุฃูุชุฑ", "ุจูุฃุฌูู ุชุงูู ๐"],
            correct: 3
        },
        {
            question: "ููุง ุญุฏ ูุฎูุต ุงูุชุงุณู ุจุฏุฑูุ ุฅุญูุง:",
            answers: ["ุจูุดู ููู ๐", "ุจูุณูู ูู", "ุจูุงุฎุฏ ุจููุต ูุจูุณูู ูู", "ุจูุณุฃูู ุฅุฒุงู ุนูู ูุฏู"],
            correct: 2
        },
        {
            question: "ููุง ุงูููุฏ ูููู 'ุนุงูุฒ feedback ุจุตุฑุงุญุฉ'ุ ุฅูุช:",
            answers: ["ุจุชููู ุฑุฃูู ุจุฌุฏ (ูุงุฒู ุชุฎุชุงุฑูุง ุบุตุจ) ", "ุจุชููู 'ูู ุญุงุฌุฉ ุญููุฉ' ุนุดุงู ุงูุฃูุงู", "ุจุชุถุญู ูุชุณูุช", "ุจุชุบููุฑ ุงูููุถูุน"],
            correct: 0
        },
        {
            question: "ุฃูุชุฑ ุญุงุฌุฉ ูู ุชุญุณูุชุ ุงูุณุงููู ูุชุจูู perfect:",
            answers: ["ุงูุงูุชุฒุงู ุจุงูููุงุนูุฏ", "ููุฉ ุงูุถุบุท", "ุฒูุงุฏุฉ ุงููุฒุงุฑ", "ุญุฐู ูููุฉ 'ุชุงุณู'"],
            correct: 3
        },
        {
            question: "ููุง ุญุฏ ูุบูุท ูู ุงูุชุงุณูุ ุฑุฏ ุงูุชูู ุจูููู:",
            answers: ["ูุฒุงุฑ ุฎููู ูุชุดุฌูุน ูุน ุงูููุฏุจุงู", "ุชุญููู ุฑุณูู", "ุจูุนูู ููู ุนููู", "ููุณู ุงูููุถูุน"],
            correct: 2
        },
        {
            question: "ูุชุฑ ููุช ุจูููู ููู ุงูุฅูุชุงุฌ ุนุงูู:",
            answers: ["ุงูุณุงุนุฉ 2 ุจุงูููู", "ูุจู ุงูุฏูุฏูุงูู ุจูุต ุณุงุนุฉ", "ุฃูู ููู ูู ุงูุชุงุณู", "ุจุนุฏ ุงูููุชููุฌ ุงูุฃูู"],
            correct: 1
        },
        {
            question: "ุฃูุชุฑ ุญุงุฌุฉ ุจุชุฎููู ุชุญุถุฑ ุงูุณูุดู ูุจุณูุท:",
            answers: ["ุงููุงุณ", "ุงูููุงุถูุน", "ุงูุชูุธูู", "ุงููุฒุงุฑ"],
            correct: 3
        },
        {
            question: "ููุง ุงูููุฏ ูููู 'ุฏู ูุฌุฑุฏ ุงุฌุชูุงุน ุจุณูุท'ุ ุชุชููุน:",
            answers: ["presentation ูุงููุฉ ๐", "ููุงุด ุทููู", "ูุนูุงู ุจุณูุท", "ุงุฌุชูุงุน ุชุงูู ุจุนุฏู"],
            correct: 1
        },
        {
            question: "ููุง ุงูุชุงุณู ูููู ูุจูุฑ ูููุ ุฃูู ุฑุฏ ูุนู ุจูููู:",
            answers: ["'ููุง ููููุง ๐ช'", "'ุฏู ุจุณูุทุฉ'", "'ุทุจ ูุจุฏุฃ ููููุ ๐'", "ุญุณุจู ุงููู ููุนูู ุงููููู"],
            correct: 3
        },
        {
            question: "ุฃูุชุฑ ุญุงุฌุฉ ูุณุชุญูู ุชุญุตู: ๐",
            answers: ["ูุจุฏุฃ ุงูููุชููุฌ ูู ูุนุงุฏู", "ุงูุชุงุณู ูุฎูุต ูู ุฃูู ูุฑูุฉ", "ุงูุฌุฑูุจ ููุถู ุณุงูุช ููู ูุงูู", "ูุญุฏุด ูุนูู ููู"],
            correct: 0
        },
        {
            question: "ุฃูู ุงูุทุจุงุนู ุนู ุงููุงูุณ ูุงู ุฅููุ ๐",
            answers: ["ุดูููุง/ุดููู ุฌุฏ ุฌุฏูุง ๐ณ", "ุทุงูุฉ ุฅูุฌุงุจูุฉ ูุฏู ุฎููู", "ุจูุฎูู ุดููุฉ ุจุณ ุดููู ุทูุจ ๐", "ุญุณูุช ุฅููุง ุฃุตุญุงุจ ูู ุฃูู ุฏูููุฉ ๐"],
            correct: 1
        },
        {
            question: "ููุง ุงูููุฏ ุจุฏุฃ ูุชููู ุนู ุงูุฎุทุฉุ ูุงู ุฅุญุณุงุณูุ ๐",
            answers: ["'ูู ุฃูุง ูู ูุญุงุถุฑุฉ ููุง ููุชูุฌุ' ๐", "'ูุงู ุงูุฎุทุฉ ุฌุงูุฏุฉ ููุชุญูุณุฉ!' ๐ช", "'ุฃูุง ูุด ูุงูู ุจุณ ูุงุดู ูุน ุงูุชูุงุฑ'", "ุญุงุณุณ ุงูู ูุณุชูุงุฏ ุงูู"],
            correct: 2
        },
        // Branch Questions
        {
            question: "๐ฆ ูุง ูู ุงูุงุฎุชุตุงุฑ ุงูุตุญูุญ ูู IEEEุ",
            answers: ["International Electrical and Energy Engineers", "Institute of Electrical and Electronics Engineers", "International Engineers of Energy and Electricity", "International Engineering of Electric Experts"],
            correct: 1
        },
        {
            question: "๐ฆ ูู ุฃู ุณูุฉ ุชุฃุณุณุช ููุธูุฉ IEEEุ",
            answers: ["1884", "1900", "1945", "2001"],
            correct: 0
        },
        {
            question: "๐ฆ ูุง ูู ุงููุฏู ุงูุฃุณุงุณู ูู IEEEุ",
            answers: ["ูุดุฑ ุซูุงูุฉ ุงูุชูููููุฌูุง ูุงูุนูู ูุงูููุฏุณุฉ", "ุชูุธูู ุญููุงุช ุชุฑููููุฉ", "ุชุทููุฑ ุชุทุจููุงุช ุชูุงุตู ุงุฌุชูุงุนู", "ุชูุฏูู ุฎุฏูุงุช ุชูุตูู ููุฑุจุงุก"],
            correct: 0
        },
        {
            question: "๐ฆ ุฃูู ููุน ุงูููุฑ ุงูุฑุฆูุณู ูููุธูุฉ IEEEุ",
            answers: ["ูููููุฑู", "ููุฏู", "ุทูููู", "ุจุงุฑูุณ"],
            correct: 0
        },
        {
            question: "๐ฆ IEEE ุชุนุชุจุฑ ุฃูุจุฑ ููุธูุฉ ุนุงูููุฉ ูู...ุ",
            answers: ["ุงูุฃุทุจุงุก", "ุงููููุฏุณูู", "ุงูููุงููู", "ุงููุญุงููู"],
            correct: 1
        },
        {
            question: "๐ฆ ูุง ุนุฏุฏ ุงูุฃุนุถุงุก ุชูุฑูุจูุง ูู IEEE ุญูู ุงูุนุงููุ",
            answers: ["100 ุฃูู", "400 ุฃูู", "ููููู", "50 ุฃูู"],
            correct: 1
        },
        {
            question: "๐ฆ ูู IEEEุ ูููุฉ 'Student Branch' ูุนูุงูุง ุฅููุ",
            answers: ["ูุฌูุฉ ูููุญุงุณุจูู", "ูุฑุน ุทูุงุจู ุชุงุจุน ูู IEEE ุฏุงุฎู ุงูุฌุงูุนุฉ", "ููุชุจ ููุฏุณู", "ูุดุงุท ุฑูุงุถู"],
            correct: 1
        },
        {
            question: "๐ฆ ูู ุงููุฌุงู ุฃู ุงููTeams ุงููู ูููู ุชูุงูููุง ุฏุงุฎู IEEEุ",
            answers: ["HR", "PR", "Technical", "ูู ูุง ุณุจู"],
            correct: 3
        },
        {
            question: "๐ฆ ุงูู IEEE ุจุชูุฏู ุฃููุงุน ุฃูุดุทุฉ ูุฎุชููุฉ ูููุง...",
            answers: ["ูุฑุด ุนูู ุชูููุฉ", "ูุณุงุจูุงุช ูุจุฑุงูุฌ ุชุฏุฑูุจ", "ูุนุงููุงุช ุชูุนููุฉ", "ูู ูุง ุณุจู"],
            correct: 3
        },
        {
            question: "๐ฆ ุฅูู ุฃุดูุฑ ูุคุชูุฑ ุจูุนููู IEEE ุณููููุง ุนุงููููุงุ",
            answers: ["CES", "IEEE Global Congress", "IEEE Xplore Conference", "IEEE International Conference"],
            correct: 3
        },
        {
            question: "๐ฆ ููุตุฉ ุงูุฃุจุญุงุซ ุงูุชุงุจุนุฉ ูู IEEE ุงุณููุง ุฅูู๏ผ",
            answers: ["IEEE Explore", "IEEE Learn", "IEEE Hub", "IEEE Docs"],
            correct: 0
        },
        {
            question: "๐ฆ ุดุนุงุฑ IEEE ููู ุฑูุฒ ุดููู ุฏุงูููุง...",
            answers: ["ูุฌูุฉ", "ูุบูุงุทูุณ", "ูุนูู (Diamond) ููู ุณูู ููุฑุจุงุฆู", "ููุฌุฉ ุตูุช"],
            correct: 2
        },
        {
            question: "๐ฆ ุฃุญุฏ ุฃูู ุฃูุฏุงู IEEE ููุทูุงุจ ูู...",
            answers: ["ุชุทููุฑ ููุงุฑุงุชูู ุงูุชูููุฉ ูุงูููุงุฏูุฉ", "ุชูุธูู ุฑุญูุงุช", "ุจูุน ููุชุฌุงุช ุฅููุชุฑูููุฉ", "ูุณุงุนุฏุฉ ูู ุงููุงุฌุจุงุช ููุท"],
            correct: 0
        },
        {
            question: "๐ฆ ุฅูู ุงูููุฒุฉ ุงููู ุจุชุฎูู IEEE ูุฎุชููุฉ ุนู ุจุงูู ุงูุฃูุดุทุฉ ุงูุทูุงุจูุฉ๏ผ",
            answers: ["ุฅููุง ุจุชุฑููุฒ ุนูู ุงูุชูููููุฌูุง ูุงูููุฏุณุฉ", "ุฅููุง ูููุง ูุณุงุจูุงุช ุบูุงุก", "ุฅููุง ุจุชูุฏู ููุฑุณุงุช ูุบุฉ", "ุฅููุง ูุดุงุท ุงุฌุชูุงุนู ููุท"],
            correct: 0
        },
        {
            question: "๐ฆ ุงูุงูุถูุงู ูู IEEE ุจูุฎููู...",
            answers: ["ุชุชุนุฑู ุนูู ูุงุณ ุฌุฏูุฏุฉ", "ุชูุชุณุจ ููุงุฑุงุช ุฌุฏูุฏุฉ", "ุชุดุงุฑู ูู ูุดุงุฑูุน ููุคุชูุฑุงุช", "ูู ูุง ุณุจู"],
            correct: 3 }
    ]
};

// Quiz State
let currentQuizState = {
    questions: [],
    currentQuestionIndex: 0,
    totalPoints: 0,
    answered: false,
    selectedAnswer: null,
    timer: null
};

// DOM Elements
const timerFill = document.querySelector('.timer-fill');
const timerText = document.querySelector('.timer-text');
const questionText = document.getElementById('questionText');
const nextStageModal = document.getElementById('nextStageModal');
const nextStageButton = document.getElementById('nextStageButton');

// Initialize Quiz
function initializeQuiz() {
    currentQuizState = {
        questions: [],
        currentQuestionIndex: 0,
        totalPoints: 0,
        answered: false,
        selectedAnswer: null,
        timer: null
    };

    currentQuizState.questions = shuffleArray([...quizData.questions]);

    if (currentQuizState.questions.length === 0) {
        questionText.textContent = "Error: No questions available!";
        return;
    }

    updateTotalQuestionsCount();
    loadQuestion();
}

// Fisher-Yates shuffle algorithm
function shuffleArray(array) {
    const shuffled = [...array];
    for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
    }
    return shuffled;
}

// Load current question
function loadQuestion() {
    const currentQuestion = currentQuizState.questions[currentQuizState.currentQuestionIndex];
    
    if (!currentQuestion) {
        showNextStage();
        return;
    }

    currentQuizState.answered = false;
    currentQuizState.selectedAnswer = null;

    questionText.textContent = currentQuestion.question || "Error loading question!";
    document.getElementById('difficultyBadge').style.display = 'none'; // Hide difficulty badge

    currentQuestion.answers.forEach((answer, index) => {
        const answerElement = document.getElementById('answer' + index);
        if (answerElement) {
            answerElement.textContent = answer || "No answer available!";
        }
    });

    updateProgress();

    document.getElementById('feedbackSection').style.display = 'none';

    document.querySelectorAll('.answer-option').forEach((option, index) => {
        option.classList.remove('selected', 'correct', 'incorrect', 'disabled');
        option.style.pointerEvents = 'auto';
        option.onclick = () => selectAnswer(index);
    });

    // Start Timer
    startTimer(10);
}

// Start Timer
function startTimer(seconds) {
    clearInterval(currentQuizState.timer);
    let timeLeft = seconds;
    timerText.textContent = timeLeft;

    const totalPerimeter = 219; // 2 * ฯ * 35
    const decrement = totalPerimeter / seconds;

    timerFill.style.strokeDashoffset = totalPerimeter;
    timerFill.style.transition = 'none'; // Reset transition

    // Force reflow to apply initial state
    timerFill.getBoundingClientRect();

    timerFill.style.transition = `stroke-dashoffset ${seconds}s linear`;
    currentQuizState.timer = setInterval(() => {
        timeLeft--;
        timerText.textContent = timeLeft;
        const dashOffset = totalPerimeter - (seconds - timeLeft) * decrement;
        timerFill.style.strokeDashoffset = dashOffset;

        if (timeLeft <= 0) {
            clearInterval(currentQuizState.timer);
            handleTimeout(currentQuizState.questions[currentQuizState.currentQuestionIndex]);
        }
    }, 1000);
}

// Handle timeout (auto move to next question as incorrect)
function handleTimeout(question) {
    currentQuizState.answered = true;
    document.querySelectorAll('.answer-option').forEach(option => {
        option.style.pointerEvents = 'none';
    });

    setTimeout(() => {
        showFeedback(false, question, -1);
    }, 300);
}

// Select an answer
function selectAnswer(answerIndex) {
    if (currentQuizState.answered) return;

    const currentQuestion = currentQuizState.questions[currentQuizState.currentQuestionIndex];
    const answerOption = document.querySelector('[data-answer="' + answerIndex + '"]');

    currentQuizState.selectedAnswer = answerIndex;
    currentQuizState.answered = true;

    answerOption.classList.add('selected');
    document.querySelectorAll('.answer-option').forEach(option => {
        option.style.pointerEvents = 'none';
    });

    clearInterval(currentQuizState.timer);

    setTimeout(() => {
        showFeedback(answerIndex === currentQuestion.correct, currentQuestion, answerIndex);
    }, 300);
}

// Create celebration effects
function createCelebrationEffects() {
    for (let i = 0; i < 12; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti celebrate';
        confetti.style.left = Math.random() * 100 + '%';
        confetti.style.top = '50%';
        const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA502', '#00D084'];
        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        document.body.appendChild(confetti);
        
        setTimeout(() => confetti.remove(), 1000);
    }
}

// Create points popup
function createPointsPopup(points) {
    const popup = document.createElement('div');
    popup.className = 'points-popup';
    popup.textContent = '+' + points;
    popup.style.left = Math.random() * 80 + 10 + '%';
    popup.style.top = '50%';
    document.body.appendChild(popup);
    
    setTimeout(() => popup.remove(), 1000);
}

// Show feedback
function showFeedback(isCorrect, question, selectedIndex) {
    const feedbackSection = document.getElementById('feedbackSection');
    const feedbackContent = document.getElementById('feedbackContent');
    const correctOption = document.querySelector('[data-answer="' + question.correct + '"]');
    let selectedOption;
    if (selectedIndex !== -1) {
        selectedOption = document.querySelector('[data-answer="' + selectedIndex + '"]');
    }

    if (isCorrect) {
        selectedOption.classList.add('correct');
        feedbackContent.innerHTML = '<span class="feedback-icon">โ</span> Correct! You earned 5 points!';
        feedbackContent.classList.add('correct');
        feedbackContent.style.color = 'var(--success-green)';
        
        currentQuizState.totalPoints += 5;

        createCelebrationEffects();
        createPointsPopup(5);

        playCorrectSound();
    } else {
        if (selectedOption) {
            selectedOption.classList.add('incorrect');
        }
        correctOption.classList.add('correct');
        feedbackContent.innerHTML = '<span class="feedback-icon">โ</span> Incorrect! The correct answer is ' + String.fromCharCode(65 + question.correct) + '.';
        feedbackContent.classList.add('incorrect');
        feedbackContent.style.color = 'var(--error-red)';

        playIncorrectSound();
    }

    updatePointsDisplay();
    feedbackSection.style.display = 'block';
}

// Update points display
function updatePointsDisplay() {
    document.getElementById('pointsValue').textContent = currentQuizState.totalPoints;
}

// Update progress
function updateProgress() {
    const progress = ((currentQuizState.currentQuestionIndex + 1) / currentQuizState.questions.length) * 100;
    document.getElementById('progressFill').style.width = progress + '%';
    document.getElementById('currentQuestion').textContent = currentQuizState.currentQuestionIndex + 1;
}

// Update total questions count
function updateTotalQuestionsCount() {
    document.getElementById('totalQuestions').textContent = currentQuizState.questions.length;
}

// Next question
function nextQuestion() {
    currentQuizState.currentQuestionIndex++;
    
    if (currentQuizState.currentQuestionIndex < currentQuizState.questions.length) {
        loadQuestion();
    } else {
        showNextStage();
    }
}

// Show next stage
async function showNextStage() {
    const modal = document.getElementById('nextStageModal');
    const urlParams = new URLSearchParams(window.location.search);
    const email = urlParams.get('email') || localStorage.getItem('userEmail');

    if (email) {
        const playersRef = collection(db, "players");
        const q = query(playersRef, where("email", "==", email));
        const querySnapshot = await getDocs(q);

        querySnapshot.forEach((docSnapshot) => {
            // Get current points from Firebase
            const currentPoints = docSnapshot.data().points || 0;
            // Update with the new total from Quiz
            const newTotalPoints = currentQuizState.totalPoints + currentPoints;
            updateDoc(docSnapshot.ref, {
                points: newTotalPoints
            }).then(() => {
                console.log("Points updated successfully for email: ", email, "New total: ", newTotalPoints);
            }).catch((error) => {
                console.error("Error updating points: ", error);
                showAlert("Error updating points. Try again.", "error");
            });
        });
    }

    modal.style.display = 'flex';
}

// Restart quiz
function restartQuiz() {
    document.getElementById('nextStageModal').style.display = 'none';
    initializeQuiz();
}

// Play correct sound
function playCorrectSound() {
    try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const now = audioContext.currentTime;
        
        const osc1 = audioContext.createOscillator();
        const gain1 = audioContext.createGain();
        osc1.connect(gain1);
        gain1.connect(audioContext.destination);
        osc1.frequency.value = 800;
        osc1.type = 'sine';
        gain1.gain.setValueAtTime(0.3, now);
        gain1.gain.exponentialRampToValueAtTime(0.01, now + 0.15);
        osc1.start(now);
        osc1.stop(now + 0.15);
        
        const osc2 = audioContext.createOscillator();
        const gain2 = audioContext.createGain();
        osc2.connect(gain2);
        gain2.connect(audioContext.destination);
        osc2.frequency.value = 1200;
        osc2.type = 'sine';
        gain2.gain.setValueAtTime(0.2, now);
        gain2.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
        osc2.start(now);
        osc2.stop(now + 0.1);
    } catch (e) {
        console.log('Audio context not available');
    }
}

// Play incorrect sound
function playIncorrectSound() {
    try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const now = audioContext.currentTime;
        
        const osc = audioContext.createOscillator();
        const gain = audioContext.createGain();
        osc.connect(gain);
        gain.connect(audioContext.destination);
        
        osc.frequency.setValueAtTime(600, now);
        osc.frequency.setValueAtTime(400, now + 0.1);
        osc.type = 'square';
        
        gain.gain.setValueAtTime(0.2, now);
        gain.gain.exponentialRampToValueAtTime(0.01, now + 0.25);
        
        osc.start(now);
        osc.stop(now + 0.25);
    } catch (e) {
        console.log('Audio context not available');
    }
}

// Show alert
function showAlert(message, type) {
    const alert = document.createElement('div');
    alert.className = 'alert-notification ' + type;
    alert.textContent = message;
    alert.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 25px;
        background: ${type === 'success' ? '#10b981' : '#ef4444'};
        color: white;
        border-radius: 8px;
        font-weight: 500;
        z-index: 1000;
        animation: slideInRight 0.3s ease-out;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    `;
    document.body.appendChild(alert);

    setTimeout(() => {
        alert.style.animation = 'slideOutRight 0.3s ease-out';
        setTimeout(() => alert.remove(), 300);
    }, 3000);

    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(100px); }
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes slideOutRight {
            from { opacity: 1; transform: translateX(0); }
            to { opacity: 0; transform: translateX(100px); }
        }
    `;
    document.head.appendChild(style);
}

// Event listeners
document.getElementById('nextButton').addEventListener('click', nextQuestion);
document.getElementById('nextStageButton').addEventListener('click', () => {
    window.location.href = 'cards.html';
});

// Initialize on page load
window.addEventListener('DOMContentLoaded', initializeQuiz);